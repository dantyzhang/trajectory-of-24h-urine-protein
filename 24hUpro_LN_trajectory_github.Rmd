---
title: "24hUpro_LN_trajectory"
author: "Danty_Zhang"
date: "2021/3/15"
output: html_document
editor_options: 
  chunk_output_type: console
---
---
title: "LN_urine trajectory"
author: "Danty_Zhang"
date: "2021/3/1"
output: html_document
---

```{r}
rm(list = ls())
library(sqldf)
library(readxl)
library(openxlsx)
options(stringsAsFactors = F)
options(scipen=200)
options(digists=2)
library(tidyr)
library(stringr)
library(lcmm)
library(lattice)
library(naniar)
library(sqldf)
# devtools::install_github('hlennon/LCTMtools')
library(LCTMtools)
library(ggplot2)
```

```{r input data}
mydata<-read.table("2.mydata.TXT",header = TRUE,check.names = FALSE)
names(mydata)<-c("ID","mon","Upro")
str(mydata)
basdata<-read_xls(path = "1.LN尿蛋白趋势基线_20210820.xls",sheet="ai更新后统计数据newonset") #baseline data
addnew<-read.xlsx("lntragectoryR20210820_IS.xlsx")
addnew<-addnew[,c(2,76,77,78,79,80)]
names(addnew)
basdata<-merge(basdata,addnew,by="ID",all.x = T)
write.xlsx(basdata,file="1基线update211011.xlsx")
basdata<-read.xlsx("1基线update211011_zdt.xlsx")
ID_NOBIOPSY<-basdata[is.na(basdata$LNCLASS),]$ID  #ID without biopsy
# nopreIS_currentIS RTX LEF FK506 AZA RTX+BLM
# RTX ALD SRL LEF RTX+BLM

IDneeded<-setdiff(mydata$ID,ID_NOBIOPSY)
mydata<-mydata[mydata$ID %in% IDneeded,]
mydata$mon<-round(mydata$mon,2)
mydata$Upro<-round(mydata$Upro,2)
mydata<-mydata[!mydata$mon>24,]  ##delete urine protein more than 24 months
```

```{r data_pre}
count<-as.data.frame(table(mydata$ID)) #217 observations
average_visit<-mean(count$Freq) #average_visit 7.6
names(mydata)
average_maxtime<-sqldf("SELECT ID,max(mon) FROM mydata GROUP BY ID") #follow-up time
average_maxfollmean<-mean(average_maxtime$`max(mon)`) #16.55

# follow-up time more than 6 months
year_2p<-average_maxtime[average_maxtime$`max(mon)`>=6,] 
year_2p<-year_2p$ID
mydata<-mydata[mydata$ID %in% year_2p,] #1513

# exclude those patients with less than 1 visit
freq<-as.data.frame(table(mydata$ID)) # 
no<-freq[freq$Freq==1,]
no<-as.vector(no$Var1)
mydata<-mydata[!mydata$ID %in% no,]  ##

# description
count<-as.data.frame(table(mydata$ID)) #197 observations ??
average_visit<-mean(count$Freq) #average_visit 7.7
summary(count$Freq)
average_maxtime<-sqldf("SELECT ID,max(mon) FROM mydata GROUP BY ID") #follow-up time
verage_maxfollmean<-mean(average_maxtime$`max(mon)`) # 16.6 mon
basdatanew<-merge(average_maxtime,basdata,by="ID",all.x = T)  #194
summary(average_maxtime)
table(data$response,data$relapse)
```


```{r trajectory all}
summary(mydata)
pdf(file ="./figures/fig1A_all_单线条.pdf",width = 10,height=7,title = "all")
color <- mydata$ID
xyplot(Upro ~ mon, mydata, groups = ID, col=color, lwd=2, type="l")
dev.off()
```


```{r normalization of urine portein values}
library(car)
library(pander)
library(forecast)
library(zoo)

testdata<-mydata
beforenor<-testdata$Upro
testdata$Upro<-testdata$Upro+0.01
a<-na.omit(testdata$Upro)
BoxCox.lambda(a,method="loglik")
summary(powerTransform(a))
afternor=bcPower(a,0.2) #normalization

#histogram of urine protein level before normalization and after normalization
par(mfrow=c(1,2))
hist(beforenor, cex.main=0.8, cex.lab=0.8,main = "before normalization",)
hist(afternor, cex.main=0.8, cex.lab=0.8,main = "after normalization",)

# mydata$year <- mydata$mon/12
# save(list = ls(all.names = TRUE),file = "bas.Rdata",envir = .GlobalEnv)
```

###LCMM

```{r STEP1 justifying the selection of a random-effect structure in the scoping model}
#############################################################
mydata$Upro<-beforenor
# mydata$Upro<-afternor
# mydata$year <- round(mydata$mon/12,1)
mydata$year <- mydata$mon/12

#> Loading required package: survival
testmodel <- hlme(Upro~year+I(year^2),mixture = ~year+I(year^2),
                  random=~-1,subject="ID",ng=3,data=mydata)

summary(testmodel)
#reference  https://rpubs.com/hlennon/LCTMtoolsvignette

colorall<-c("#7876B1FF","#BC3C29FF","#E18727FF")
residualplot_step1 <- function (model, nameofoutcome, nameofage, data, 
            ylimit = c(-50, 50)) 
{
                    require(dplyr)
                    k <- model$ng
                    preds <- model$pred
                    names(preds)[6] <- nameofoutcome
                    nameofid <- names(model$pred)[1]
                    test <- dplyr::left_join(preds, model$pprob, .by = nameofid)
                    test <- cbind(test,data[,c(2,4)])
                     # dplyr::left_join(test, data, .by = c(nameofid, nameofoutcome))
                    plotvalues <- NULL
                    for (i in 1:k) {
                                        colour<-colorall[i]
                                        newplotvalues <- test %>% filter(class == i) %>% mutate(Residuals = get(nameofoutcome) - 
                                                                                                                    eval(parse(text = paste0("pred_ss", i))))
                                        plotvalues <- rbind(plotvalues, newplotvalues)
                                        plotvaluessub <- plotvalues %>% filter(class == i)
                                        pname <- paste0("p", i)
                                        assign(pname, ggplot2::ggplot(data = plotvaluessub, aes(x = get(nameofage), 
                                                                                                y = Residuals, group = class)) + theme(axis.text = element_text(size = 16), 
                                                                                                                                       text = element_text(size = 16)) + geom_point(colour=colour,shape=21,size=1,fill=colour,alpha = 0.4)  
                                               
                                               
                                               +geom_smooth(method="loess",colour=colour,alpha = 0.6,se = FALSE,size=1.3)
          # + stat_summary(fun.y = mean, geom = "line", size = 3, col = "CadetBlue", group = 1) 
          + ggtitle("Residuals in class", i) + ylim(ylimit))
                                        print(eval(parse(text = (paste0("p", i)))))
                                        plotname <- paste0("p", i, ".pdf")
                                        ggplot2::ggsave(filename = plotname)
                    }
                    return(as.list(get(dput(paste0("p", 1:k)))))
}

residualplot_step1( testmodel, nameofoutcome="Upro",nameofage = "year",
                    data = mydata,ylimit=c(-5,5))
```


```{r Step 2 determine the optimal number of classes based on BIC}
mydata$Upro<-beforenor
# mydata$Upro<-afternor
mydata$year <- round(mydata$mon/12,2)


mlc1 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata)

mlc2 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 2)

mlc3 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 3)

mlc4 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 4)

mlc5 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 5)

mlc6 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 6)

mlc7 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 7)

mlc8 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 8)

mlc9 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 9)

mlc10 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 10)

# save(mlc1,mlc2,mlc3,mlc4,mlc5,mlc6,mlc7,mlc8,mlc9,mlc10,file = "./figures/time2_lcmm_optimalnumber.Rdata")
load("./figures/time2_lcmm_optimalnumber.Rdata")
model_num<-summarytable(mlc1,mlc2,mlc3,mlc4,mlc5,mlc6,mlc7,mlc8,mlc9,mlc10,which = c("G", "loglik", "conv", "npm", "AIC", "BIC", "SABIC", "entropy", "%class"))
write.xlsx(model_num,file = "./figures/time2_lcmm_optimalnumber_194.xlsx")
```

```{r LCMM  Step 3&4 refine the model_with original 24h urine protein}
mydata$Upro<-beforenor
# mydata$Upro<-afternor
mydata$year <- round(mydata$mon/12,2)

##beforenor degree=1 linear
bl1 <- lcmm(Upro ~ poly(year, degree = 1, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 1, raw = TRUE), ng = 4)

##beforenor degree=2 linear
bl2 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 4)

##beforenor degree=3 linear
bl3 <- lcmm(Upro ~ poly(year, degree = 3, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 3, raw = TRUE), ng = 4)

##beforenor degree=1 beta
bb1 <- lcmm(Upro ~ poly(year, degree = 1, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 1, raw = TRUE), ng = 4, link = "beta")

##beforenor degree=2 beta
bb2 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 4, link = "beta")

##beforenor degree=3 beta
bb3 <- lcmm(Upro ~ poly(year, degree = 3, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 3, raw = TRUE), ng = 4, link = "beta")

# save(bl1,bl2,bl3,bb1,bb2,bb3,file="./figures/refine_beforenormal.Rdata")
```

```{r LCMM  Step 3&4 refine the model_with normalized 24h upro}
mydata$Upro<-afternor
mydata$year <- round(mydata$mon/12,2)

##afternor degree=1 linear
bl1 <- lcmm(Upro ~ poly(year, degree = 1, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 1, raw = TRUE), ng = 4)

##afternor degree=2 linear
bl2 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 4)

##afternor degree=3 linear
bl3 <- lcmm(Upro ~ poly(year, degree = 3, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 3, raw = TRUE), ng = 4)

##afternor degree=1 beta
bb1 <- lcmm(Upro ~ poly(year, degree = 1, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 1, raw = TRUE), ng = 4, link = "beta")

##afternor degree=2 beta
bb2 <- lcmm(Upro ~ poly(year, degree = 2, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 2, raw = TRUE), ng = 4, link = "beta")

##afternor degree=3 beta
bb3 <- lcmm(Upro ~ poly(year, degree = 3, raw = TRUE),random = ~ year, subject = "ID", data = mydata, mixture =~ poly(year, degree = 3, raw = TRUE), ng = 4, link = "beta")

# save(bl1,bl2,bl3,bb1,bb2,bb3,file="./figures/refine_afternormal.Rdata")
```

```{r LCMM Step 3&4 compare the refined models}
load("./figures/refine_beforenormal.Rdata")
model_refine1<-summarytable(bl1,bl2,bl3,bb1,bb2,bb3,which = c("G", "loglik", "conv", "npm", "AIC", "BIC", "SABIC", "entropy", "%class"))
model_refine1<-as.data.frame(model_refine1)
model_refine1$urinepro<-"beforenor"
model_refine1$time<-c("linear","Quadratic","Cubic","linear","Quadratic","Cubic")
model_refine1$spline<-c("linear","linear","linear","beta","beta","beta")
write.xlsx(model_refine1,file = "./figures/refine_beforenormal.xlsx")

load("./figures/refine_afternormal.Rdata")
model_refine2<-summarytable(bl1,bl2,bl3,bb1,bb2,bb3,which = c("G", "loglik", "conv", "npm", "AIC", "BIC", "SABIC", "entropy", "%class"))
model_refine2<-as.data.frame(model_refine2)
model_refine2$urinepro<-"afternor"
model_refine2$time<-c("linear","Quadratic","Cubic","linear","Quadratic","Cubic")
model_refine2$spline<-c("linear","linear","linear","beta","beta","beta")

model_refine<-rbind(model_refine1,model_refine2)
write.xlsx(model_refine,file = "./figures/refine_model4G.xlsx")
##bb3 had lowest BIC

mydata$Upro<-beforenor
# mydata$Upro<-afternor
mydata$year <- round(mydata$mon/12,2)
?LCTMtoolkit

load("./figures/refine_beforenormal.Rdata")
LCTMtoolkit(bb3) 
29.443/10
lcmm::postprob( bb3 )

# Posterior classification: 
#   class1 class2 class3 class4
# N  49.00  47.00  57.00  41.00
# %  25.26  24.23  29.38  21.13
#  
# Posterior classification table: 
#      --> mean of posterior probabilities in each class 
#         prob1  prob2  prob3  prob4
# class1 0.7983 0.0708 0.1250 0.0059
# class2 0.0635 0.7521 0.0304 0.1540
# class3 0.1335 0.0253 0.8366 0.0046
# class4 0.0102 0.1218 0.0249 0.8430
#  
# Posterior probabilities above a threshold (%): 
#          class1 class2 class3 class4
# prob>0.7  65.31  61.70  77.19  75.61
# prob>0.8  59.18  46.81  61.40  65.85
# prob>0.9  40.82  34.04  54.39  53.66
#  

summary(bb3)
```

```{r load basdata and LCMM results}
load("./figures/refine_beforenormal.Rdata")
load("bas.Rdata")
mydata$Upro<-beforenor
```


```{r STEP5-graphical presentation-Plot mean trajectories with 95% predictive intervals across time for each class in a single graph.}
plot(bb3, which="fit", var.time="mon", marg=FALSE, ylim=c(-6,1),shades = TRUE)

pdf(file ="./figures/ng=4.pdf",width = 10,height=9,title = "trajectory")
plot(bb3, which="fit", var.time="mon", marg=FALSE, ylim=c(-6,1),shades = TRUE)
dev.off()

png(file = "./figures/ng=4.png", bg = "transparent")
plot(bb3, which="fit", var.time="mon", marg=FALSE, ylim=c(-6,1),shades = TRUE)
dev.off()

# datnew   <- data.frame(year = seq(0, 2, length = 500))
# plotpred <- predictY(bb3, datnew, var.time ="year", draws = TRUE)
# plot(plotpred, lty=1, xlab="year", ylab="24h-Upro", cex=0.75)
```

```{r STEP5-graphical presentation-individual level ‘spaghetti plots’  }
mydata$Upro<-beforenor
## output
class4<-bb3$pprob
write.xlsx(class4,"./figures/class4_bb3_ng4_194.xlsx")

#class4-----------------------
class4c1<-class4$ID[class4$class==1]
class4c2<-class4$ID[class4$class==2]
class4c3<-class4$ID[class4$class==3]
class4c4<-class4$ID[class4$class==4]

dat_c1<-mydata[mydata$ID %in% class4c1,]
dat_c2<-mydata[mydata$ID %in% class4c2,]
dat_c3<-mydata[mydata$ID %in% class4c3,]
dat_c4<-mydata[mydata$ID %in% class4c4,]

#subclass---------------------------------
# layout(matrix(c(1,2,3,4), 2, 2))
# "#BC3C29FF" "#0072B5FF" "#E18727FF" "#20854EFF" "#7876B1FF" "#6F99ADFF" "#FFDC91FF" "#EE4C97FF" 

xyplot(Upro ~ mon, dat_c1, groups = ID, col="black", lwd=2, type="l")
xyplot(Upro ~ mon, dat_c2, groups = ID, col="#BC3C29FF", lwd=2, type="l") #red
xyplot(Upro ~ mon, dat_c3, groups = ID, col="#20854EFF", lwd=2, type="l") #green
xyplot(Upro ~ mon, dat_c4, groups = ID, col="#0072B5FF", lwd=2, type="l") #blue

## 
pdf(file ="./figures/c41.pdf",width = 10,height=7,title = "all")
xyplot(Upro ~ mon, dat_c1, groups = ID, col="black", lwd=2, type="l")
dev.off()

pdf(file ="./figures/c42.pdf",width = 10,height=7,title = "all")
xyplot(Upro ~ mon, dat_c2, groups = ID, col="#BC3C29FF", lwd=2, type="l")
dev.off()

pdf(file ="./figures/c43.pdf",width = 10,height=7,title = "all")
xyplot(Upro ~ mon, dat_c3, groups = ID, col="#20854EFF", lwd=2, type="l")
dev.off()

pdf(file ="./figures/c44.pdf",width = 10,height=7,title = "all")
xyplot(Upro ~ mon, dat_c4, groups = ID, col="#0072B5FF", lwd=2, type="l")
dev.off()

## spaghetti
mydata2<-merge(mydata,class4[,c(1,2)],by="ID",all.x = T)
library(ggplot2)
names(mydata2)
mydata2$class<-as.factor(mydata2$class)

mydata2$class2<-mydata2$class
mydata2$class2<-str_replace_all(mydata2$class2,"1","6ER_HB")
mydata2$class2<-str_replace_all(mydata2$class2,"2","7LR")
mydata2$class2<-str_replace_all(mydata2$class2,"3","5ER_LB")
mydata2$class2<-str_replace_all(mydata2$class2,"4","8NR")
ggplot(mydata2, aes(x = mon, y = Upro)) + geom_line(aes(color = class2,group = ID),alpha=0.7) + xlab("months") + ylab("24h-Urine protein")+ labs(color = "Class Assignment")+theme_classic()+ geom_hline(aes(yintercept=0.3), colour="#990000", linetype="dashed")

ggplot2::ggsave(filename = "./figures/spaghetti_plots_4g.pdf",width = 6,height = 4)
ggplot2::ggsave(filename = "./figures/spaghetti_plots_4g.png",width = 6,height = 4)
```

##STEP7 Assess for clinical characterisation and plausibility.

```{r datapre_description of different groups_variables}
##data pre 
load("./figures/refine_beforenormal.Rdata")
load("bas.Rdata")
mydata$Upro<-beforenor
class4<-bb3$pprob

table(basdatanew$ID==class4$ID)
data<-cbind(basdatanew,fclass4=class4[,c(2)])

vars<-names(data);dput(vars)
str(data)

vars<-c("gender", "age", "age35", 
        "sleduration", "LNduration", "newonsetLN",  "AKI","max(mon)","followup", 
        "proliferate", "membrane", "LNCLASS", "LNCLASS_si",
        "IorII", "III", "IV", "mix","V","TMA", 
        "AI",  "CI", 
        "debri", "wireloop", "necrosis", 
        "cellcrescent", "fibrocrescent", "sclerosis", "TIsclerosis", "TIshrink",
        "HB","PLT","UP24H","ALB","RBC", "CR","BNP", "DD",
        "ESR", "CRP", "IGG", "C3", "C4", "DSdna","acl", "HTN",
        "SLEDAI", "SLEDAI12", 
        "Pred", "priois", "subis", 
        "response", "noresponse","remissionmonth",  
        "esrd", "die", "relapse",
        "nopreIScurrentIS","IScurrentpre","CTX","MMF","response_all",
        "fclass4")

factorvars<-c("gender", "age35","SLEDURATION5", 
"newonsetLN",  "AKI", "proliferate", "membrane", "LNCLASS", "LNCLASS_si",
"IorII", "III", "IV", "mix","V", "TMA", "TIsclerosis","debri", "wireloop", "necrosis", "HTN","acl", "SLEDAI12","response", "noresponse", "esrd", "die", "relapse","nopreIScurrentIS","IScurrentpre", "CTX","MMF","response_all","fclass4")

data[factorvars]<-lapply(data[factorvars],factor)
numvars<-setdiff(vars,factorvars)
data[numvars]<-lapply(data[numvars],as.numeric)

#output for spss 2*c chi suqer
spssdata<-data[,factorvars]
write.csv(spssdata,"spssdata.csv")

spssdata<-data[,c(numvars,"fclass4")]
write.csv(spssdata,"spssdata_num.csv")
```


```{r ggbetweenstats boxplot}
library(ggstatsplot)
library(ggplot2)
set.seed(123)

data$fclass4 <-str_replace_all(data$fclass4 ,"2","5LR")
data$fclass4 <-str_replace_all(data$fclass4 ,"1","2ER_HB")
data$fclass4 <-str_replace_all(data$fclass4 ,"3","0ER_LB")
data$fclass4 <-str_replace_all(data$fclass4,"4","6NR")


name<-"age"
sta<-data.frame(var=data[,name],fclass4=data$fclass4)
p.picture=paste("./figures/betweengroup/",name,"lnd","test.jpg",sep = "")
jpeg(p.picture)
ggstatsplot::ggbetweenstats(
  data = sta,
  type="nonparametric",
  pairwise.comparisons = TRUE, pairwise.display = "significant", 
  p.adjust.method = "bonferroni",  #"holm" (default), "hochberg", "hommel", "bonferroni", "BH", "BY", "fdr", "none"
  effsize.type = "unbiased",
  x = fclass4,
  y = var,
  title = "Distribution of sepal length across Iris species")
dev.off()


sig<-c("age", "sleduration","LNduration","AI","cellcrescent","sclerosis", "TIshrink","UP24H","ALB","RBC","CR","BNP", "CRP","IGG",
        "Pred", "priois", "subis", 
       "remissionmonth")
```


```{r comparison of different groups}
str(data)
library("tableone")#baseline table
a<-data
#---------------------base----------------------
attach(a)
table <- CreateTableOne(vars = vars, factorVars = factorvars,data = a)
table <- print(table, missing = TRUE,smd = TRUE,showAllLevels = TRUE)#,nonnormal=numvars
##exact=c("esrd","die","acl")#nonnormal = c() ,nonnormal =nonnormal_C2_res
table1 <- print(table, smd = TRUE)
detach(a)
write.csv(table1, file = "./figures/v3_baseline_mean.csv")
excel<-read.csv("./figures/v3_baseline_mean.csv")
write.xlsx(excel,"./figures/v3_baseline_mean.xlsx")
table(a$response,a$relapse)
table(a$response)
############
attach(a)
table <- CreateTableOne(vars = vars, factorVars = factorvars,data = a)
table <- print(table, missing = TRUE,smd = TRUE,showAllLevels = TRUE,nonnormal=numvars)#
##exact=c("esrd","die","acl")#nonnormal = c() ,nonnormal =nonnormal_C2_res
table1 <- print(table, smd = TRUE)
detach(a)
write.csv(table1, file = "./figures/v3_baseline_non.csv")
excel<-read.csv("./figures/v3_baseline_non.csv")
write.xlsx(excel,"./figures/v3_baseline_non.xlsx")
table(a$response,a$relapse)
table(a$response)
16/(116+16)
#----------------------lanclass4-----------------------
attach(a)
table <- CreateTableOne(vars = vars, strata = 'fclass4', factorVars = factorvars,data = a)
table <- print(table, missing = TRUE,smd = TRUE,showAllLevels = TRUE,nonnormal =numvars)##exact=c("esrd","die","acl")#nonnormal = c( )
table1 <- print(table, smd = TRUE)
detach(a)
write.csv(table1, file = "./figures/v3_class4_nonnor.csv")
excel<-read.csv("./figures/v3_class4_nonnor.csv")
write.xlsx(excel,"./figures/v3_class4_nonnor.xlsx")

#----------------------lanclass4-----------------------
attach(a)
table <- CreateTableOne(vars = vars, strata = 'fclass4', factorVars = factorvars,data = a)
table <- print(table, missing = TRUE,smd = TRUE,showAllLevels = TRUE,nonnormal = c( ))##exact=c("esrd","die","acl")
table1 <- print(table, smd = TRUE)
detach(a)
write.csv(table1, file = "./figures/v3_class4_nor.csv")
excel<-read.csv("./figures/v3_class4_nor.csv")
write.xlsx(excel,"./figures/v3_class4_nor.xlsx")
```


```{r_imputation}
library("naniar")
library("mice")
str(data)
#有p值的

varsneed<-c("gender", "age", "sleduration", "LNduration", "newonsetLN",  "AKI","followup", 
        "proliferate", "membrane", "LNCLASS", "LNCLASS_si",
        "IorII", "III", "IV", "mix","V","TMA", 
        "AI",  "CI", 
        "debri", "wireloop", "necrosis", 
        "cellcrescent", "fibrocrescent", "sclerosis", "TIsclerosis", "TIshrink",
        "HB","PLT","UP24H","ALB","RBC", "CR","BNP", "DD",
        "ESR", "CRP", "IGG", "C3", "C4", "DSdna","acl", "HTN",
        "SLEDAI", "SLEDAI12", 
        "Pred", "priois", "subis", 
        "response", "noresponse","remissionmonth",  
        "esrd", "die", "relapse",
        "nopreIScurrentIS","IScurrentpre","CTX","MMF","response_all",
        "fclass4")


basdatatree<-data[,varsneed]


#priois
f="basdatatree_out.Rdata"
if(file.exists(f)==F){
library(mice)
miceMod <- mice(basdatatree[,!names(basdatatree) %in% "medv"], method="rf") #based on random forest
basdatatree_out <- complete(miceMod);anyNA(basdatatree_out)
save(basdatatree_out, file = "basdatatree_out.Rdata")
write.csv(basdatatree_out, file = "basdatatree_out.csv")
}

```


```{r multi_nom_all variabels with p_data_pre}
load("./figures/refine_beforenormal.Rdata")
load("bas.Rdata")
mydata$Upro<-beforenor
class4<-bb3$pprob
table(basdatanew$ID==class4$ID)
data<-cbind(basdatanew,fclass4=class4[,c(2)])
load("basdatatree_out.Rdata")

df<-basdatatree_out[,c("age", "sleduration","AI", "cellcrescent","sclerosis", "TIsclerosis","TIshrink","UP24H","ALB","RBC","CR",  "BNP","CRP","IGG","HTN","nopreIScurrentIS")]

df_cor=cor(df)

kappa(df_cor, exact=T)  ###1000 无多重共线性

library(foreign)
library(nnet)
library(ggplot2)
library(reshape2)

basdatatree_out$fclass4<-as.factor(basdatatree_out$fclass4)
```

```{r multi_nom_all variabels with p_LB_ref}
basdatatree_out$fclass4 <- relevel(basdatatree_out$fclass4, ref = "0ER_LB") 
basdatatree_out$LNCLASS_si <- relevel(basdatatree_out$LNCLASS_si, ref = "mix") 


dput(names(basdatatree_out))

muldata1<-basdatatree_out[,c("age","gender","sleduration",  "LNduration", "newonsetLN", "AKI", "LNCLASS_si","AI", "debri", "cellcrescent", "sclerosis", "TIshrink", "TIsclerosis","UP24H", "ALB", "RBC", "CR", "BNP", "CRP", "IGG", "HTN","priois", "fclass4")] 
test <- multinom(muldata1$fclass4 ~ ., data = muldata1)


#p
z <- summary(test)$coefficients/summary(test)$standard.errors 
p <- (1 - pnorm(abs(z), 0, 1)) * 2;p<-t(p);p<-as.data.frame(p)
names(p)<-c("LRp_value","ERHBp_value","NRp_value")

#OR
OR<-exp(coef(test)); OR<-t(OR);OR<-as.data.frame(OR)
names(OR)<-c("LROR","ERHBOR","NROR")
CI<-exp(confint(test));CI<-as.data.frame(CI)
names(CI)<-c("LR_lower", "LR_upper", "ERHB_lower", "ERHB_upper","NR_lower", "NR_upper")

rownames(p)==rownames(OR);rownames(OR)==rownames(CI)
out_mul1<-cbind(OR,CI,p)
dput(names(out_mul1))
out_mul1<-out_mul1[,c("ERHBOR","ERHB_lower",  "ERHB_upper",  "ERHBp_value",
                      "LROR", "LR_lower", "LR_upper", "LRp_value", 
                      "NROR", "NR_lower", "NR_upper", "NRp_value")]
out_mul2<-lapply(out_mul1,function(x) round(x,2));out_mul2<-as.data.frame(out_mul2) ##round
rownames(out_mul2)<-rownames(out_mul1)

out_mul2$ERHBOR_95CI<-paste(out_mul2$ERHBOR," (",out_mul2$ERHB_lower,",",out_mul2$ERHB_upper,")",sep="")
out_mul2$LROR_95CI<-paste(out_mul2$LROR," (",out_mul2$LR_lower,",",out_mul2$LR_upper,")",sep="")
out_mul2$NROR_95CI<-paste(out_mul2$NROR," (",out_mul2$NR_lower,",",out_mul2$NR_upper,")",sep="")
dput(names(out_mul2))
out_mul2<-out_mul2[,c( "ERHBOR_95CI","ERHBp_value", "LROR_95CI","LRp_value", "NROR_95CI","NRp_value")]

# write.xlsx(out_mul2,file="./figures/multino_bi_reg_round3_LBref.xlsx",row.names=T)
write.xlsx(out_mul2,file="./figures/multino_bi_reg_round2_LBref.xlsx",row.names=T)

head(pp <- fitted(test)) #probability

```


```{r multi_nom_all variabels with p_NR_ref}
basdatatree_out$fclass4 <- relevel(basdatatree_out$fclass4, ref = "6NR") 
basdatatree_out$LNCLASS_si <- relevel(basdatatree_out$LNCLASS_si, ref = "mix") 

dput(names(basdatatree_out))
muldata1<-basdatatree_out[,c("age","gender","sleduration",  "LNduration", "newonsetLN", "AKI", "LNCLASS_si","AI", "debri", "cellcrescent", "sclerosis", "TIshrink", "TIsclerosis","UP24H", "ALB", "RBC", "CR", "BNP", "CRP", "IGG", "HTN","priois", "fclass4")] 
test <- multinom(muldata1$fclass4 ~ ., data = muldata1)

#p
z <- summary(test)$coefficients/summary(test)$standard.errors 
p <- (1 - pnorm(abs(z), 0, 1)) * 2;p<-t(p);p<-as.data.frame(p)
names(p)<-c("ERLBp_value","LRp_value","ERHBp_value")

#OR
OR<-exp(coef(test)); OR<-t(OR);OR<-as.data.frame(OR)
names(OR)<-c("ERLBOR","LROR","ERHBOR")
CI<-exp(confint(test));CI<-as.data.frame(CI)
names(CI)<-c("ERLB_lower", "ERLB_upper","LR_lower", "LR_upper", "ERHB_lower", "ERHB_upper")

rownames(p)==rownames(OR);rownames(OR)==rownames(CI)
out_mul1<-cbind(OR,CI,p)
dput(names(out_mul1))
out_mul1<-out_mul1[,c("ERLBOR", "ERLB_lower", "ERLB_upper", "ERLBp_value",
                      "ERHBOR","ERHB_lower",  "ERHB_upper",  "ERHBp_value",
                      "LROR", "LR_lower", "LR_upper", "LRp_value"
                      )]
out_mul2<-lapply(out_mul1,function(x) round(x,2));out_mul2<-as.data.frame(out_mul2) 
##round
rownames(out_mul2)<-rownames(out_mul1)

out_mul2$ERHBOR_95CI<-paste(out_mul2$ERHBOR," (",out_mul2$ERHB_lower,",",out_mul2$ERHB_upper,")",sep="")
out_mul2$LROR_95CI<-paste(out_mul2$LROR," (",out_mul2$LR_lower,",",out_mul2$LR_upper,")",sep="")
out_mul2$ERLBOR_95CI<-paste(out_mul2$ERLBOR," (",out_mul2$ERLB_lower,",",out_mul2$ERLB_upper,")",sep="")
dput(names(out_mul2))
out_mul2<-out_mul2[,c( "ERHBOR_95CI","ERHBp_value", "LROR_95CI","LRp_value", "ERLBOR_95CI","ERLBp_value")]

write.xlsx(out_mul2,file="./figures/multino_bi_reg_round2_NRref.xlsx",row.names=T)

head(pp <- fitted(test)) #probability
```


```{r PCA}
load("./figures/refine_beforenormal.Rdata")
load("bas.Rdata")
mydata$Upro<-beforenor
class4<-bb3$pprob
table(basdatanew$ID==class4$ID)
data<-cbind(basdatanew,fclass4=class4[,c(2)])
load("basdatatree_out.Rdata")

write.xlsx(basdatatree_out,file = "PCA.xlsx")
basdatatree_out<-read.xlsx("PCA_zdt.xlsx")

dput(varneed)
varneed<-names(basdatatree_out)

numvars<-c("ID", "gender", "age", "sleduration", "LNduration", "newonsetLN", 
"AKI", "IorII", "III", "IV", "mix", "V", 
"AI", "debri", "cellcrescent", "sclerosis", "TIshrink", 
"TIsclerosis", "UP24H", "ALB", "RBC", "CR", "BNP", "DD", "CRP", 
"IGG", "HTN", "Pred", "priois", "MMF", "CTX", "SLEDAI", "fclass4")

basdatatree_out1<-basdatatree_out[,numvars]

basdatatree_out1[numvars]<-lapply(basdatatree_out1[numvars],as.numeric)

summary(basdatatree_out1)
library(ggfortify)
pca1<-prcomp(basdatatree_out1[,c(-1,-33)],scale=T,rank=4,retx=T)  #相关矩阵分解 #retx表四返回score，scale表示要标准化

summary(pca1) #方差解释度
	pca1$sdev #特征值的开方
	pca1$rotation #特征向量，回归系数
	pca1$x #样本得分score
basdatatree_out1$fclass4<-as.factor(basdatatree_out1$fclass4)
autoplot(pca1,data = basdatatree_out1,col= 'fclass4',size=2,
         loadings =T,loadings.label = TRUE,
         frame = TRUE,frame.type='norm',
         label = TRUE, label.size = 3
)+  theme_classic()

library("pca3d")
# install.packages("pca3d",repos="https://mran.microsoft.com/snapshot/2019-02-01/") ##
pca3d(pca1, group= basdatatree_out1[,33])
?pca3d
pca3d(pca1, group= basdatatree_out1[,33],
     show.ellipses = T,ellipse.ci = 0.95,
     show.group.labels = T,
     show.shapes = TRUE,
      axes.color= "white", new= TRUE)

       #fancy= TRUE, 
       # bg= "black",
```

```{r_decision tree}
library(party)
library(mlbench)

str(muldata1)
# muldata1$V<-as.numeric(muldata1$V)
# muldata1$mix<-as.numeric(muldata1$mix)
# 
# muldata1$vmix<-muldata1$V+muldata1$mix
# muldata1$vmix<-ifelse(muldata1$vmix<3,0,1)
# 
# muldata1$V<-as.factor(muldata1$V)
# muldata1$mix<-as.factor(muldata1$mix)
# muldata1$vmix<-as.factor(muldata1$vmix)

str(muldata1)
set.seed(12)
ind <- sample(2, nrow(muldata1), replace=TRUE, prob=c(0.7, 0.3))
trainData <- muldata1[ind==1,]
testData <- muldata1[ind==2,]

# trainData<-muldata1
control<-ctree_control(mincriterion= 0.2)
m1_ctree<-ctree(trainData$fclass4 ~., data = trainData,controls = control)
table(predict(m1_ctree), trainData$fclass4)
plot(m1_ctree)

print(iris_ctree)

plot(iris_ctree)
str(muldata1)

plot(m1_ctree)
```

###merge ER_HB,LR,NR and then compare them with ER_LB

```{r merge_ER_LBvsOTHERS_variabels with p_data_pre}
load("./figures/refine_beforenormal.Rdata")
load("bas.Rdata")
mydata$Upro<-beforenor
class4<-bb3$pprob
table(basdatanew$ID==class4$ID)
data<-cbind(basdatanew,fclass4=class4[,c(2)])
load("basdatatree_out.Rdata")

df<-basdatatree_out[,c("age", "sleduration","AI", "cellcrescent","sclerosis", "TIshrink","UP24H","ALB","RBC","CR",  "BNP", "DD", "CRP","IGG","SLEDAI")]
df_cor=cor(df)
kappa(df_cor, exact=T)  ###1000 无多重共线性

library(foreign)
library(nnet)
library(ggplot2)
library(reshape2)

basdatatree_out$fclass4 <-str_replace_all(basdatatree_out$fclass4 ,"2ER_HB","IR")
basdatatree_out$fclass4 <-str_replace_all(basdatatree_out$fclass4 ,"5LR","IR")
basdatatree_out$fclass4 <-str_replace_all(basdatatree_out$fclass4 ,"0ER_LB","ER_LB")
basdatatree_out$fclass4 <-str_replace_all(basdatatree_out$fclass4,"6NR","IR")
basdatatree_out$fclass4<-ifelse(basdatatree_out$fclass4=="IR",0,1)

basdatatree_out$fclass4<-as.factor(basdatatree_out$fclass4)

basdatatree_out$fclass4 <- relevel(basdatatree_out$fclass4, ref = "0") 
basdatatree_out$LNCLASS_si <- relevel(basdatatree_out$LNCLASS_si, ref = "mix")
```


```{r_data_pre}
dput(names(basdatatree_out))
muldata1<-basdatatree_out[,c("age","gender","sleduration",  "LNduration", "newonsetLN", "AKI", "LNCLASS_si","IorII", "III", "IV", "mix", "V","AI", "debri", "cellcrescent", "sclerosis", "TIshrink", "TIsclerosis","UP24H", "ALB", "RBC", "CR", "BNP", "CRP", "IGG", "HTN","priois", "fclass4")] ##去掉激素量

vars<-c("age","gender","sleduration",  "LNduration", "newonsetLN", "AKI", "LNCLASS_si","IorII", "III", "IV", "mix", "V","AI", "debri", "cellcrescent", "sclerosis", "TIshrink", "TIsclerosis","UP24H", "ALB", "RBC", "CR", "BNP", "CRP", "IGG", "HTN","priois", "fclass4")

numvars<-c("age","sleduration",  "LNduration", "AI",  "cellcrescent", "sclerosis", "TIshrink","UP24H", "ALB", "RBC", "CR", "BNP", "CRP", "IGG","priois")

factorvars<-setdiff(vars,numvars)
```


```{r comparison of different groups_table1}
str(data)
a<-basdatatree_out
#------------------------------------------------------
library("tableone")#baseline table
#----------------------lanclass4-----------------------
attach(a)
table <- CreateTableOne(vars = vars, strata = 'fclass4', factorVars = factorvars,data = a)
table <- print(table, missing = TRUE,smd = TRUE,showAllLevels = TRUE,nonnormal =numvars)##exact=c("esrd","die","acl")#nonnormal = c( )
table1 <- print(table, smd = TRUE)
detach(a)
write.csv(table1, file = "./figures/v3_LBvsOTHER.csv")
excel<-read.csv("./figures/v3_LBvsOTHER.csv")
write.xlsx(excel,"./figures/v3_LBvsOTHER.xlsx")

#----------------------lanclass4-----------------------
attach(a)
table <- CreateTableOne(vars = vars, strata = 'fclass4', factorVars = factorvars,data = a)
table <- print(table, missing = TRUE,smd = TRUE,showAllLevels = TRUE,nonnormal = c( ))##exact=c("esrd","die","acl")
table1 <- print(table, smd = TRUE)
detach(a)
write.csv(table1, file = "./figures/v3_LBvsOTHER_nor.csv")
excel<-read.csv("./figures/v3_LBvsOTHER_nor.csv")
write.xlsx(excel,"./figures/v3_LBvsOTHER_nor.xlsx")
```


```{r_separate data to a traing set and a testing set}
str(muldata1)
set.seed(1984) #1984 2019 1984四临床因素

# muldata1<-muldata1[,c(23,1:22)]
# muldata1$fclass4<-ifelse(muldata1$fclass4=="ER_LB","1","0")
# muldata1$fclass4<-as.factor(muldata1$fclass4)

ind <- sample(2, nrow(muldata1), replace=TRUE, prob=c(0.7, 0.3))
trainData <- muldata1[ind==1,]
testData <- muldata1[ind==2,]

trainData<-trainData[,c("fclass4", "age", "gender", "sleduration", "LNduration", "newonsetLN",
"AKI", "LNCLASS_si","AI", "debri", "cellcrescent", "sclerosis",
"TIshrink", "TIsclerosis", "UP24H", "ALB", "RBC", "CR", "BNP",
"CRP", "IGG", "HTN")]
# save(trainData,file="traindata.Rdata")
# save(testData,file="testdata.Rdata")
```


```{r CUTOFF_training set}
traincut<-trainData
traincut$fclass4<-as.factor(traincut$fclass4)

newcutoffcol=function(f){
library("OptimalCutpoints")
datacut<-traincut[,c("fclass4",f)]
optimal.Youden <- optimal.cutpoints(X =f,status ="fclass4",tag.healthy =1,
                                    methods ="Youden",data = datacut,
                                    ci.fit = TRUE, conf.level = 0.95)
cutoff<-optimal.Youden[["Youden"]][["Global"]][["optimal.cutoff"]]$cutoff
cat(cutoff)
plot(optimal.Youden, which = 1,col = "red", ylim = c(0,1)) #plot1
plot(optimal.Youden, which = 3,col = "red", ylim = c(0,1)) #plot2
colname<-paste(f,cutoff, sep = "_")
newcol<-as.data.frame(ifelse(traincut[,f] >= cutoff , "1", "0"))
colnames(newcol)<-colname
traincut<-cbind(traincut,newcol)
                        }

for(i in c("sleduration",  "LNduration", "AI",  "cellcrescent", "sclerosis", "TIshrink","UP24H",  "RBC", "CR", "BNP", "CRP")){traincut<-newcutoffcol(i)}
#generate new col according to cutoff value

dput(names(traincut))

for(i in c("sleduration_0.92", "LNduration_0.17", "AI_7", 
"cellcrescent_0.14", "sclerosis_0.32", "TIshrink_10", "UP24H_2.4", 
"RBC_27", "CR_101", "BNP_26", "CRP_0.43")) {traincut[,i] <- as.factor(traincut[,i])}


newcutoffcol=function(f){
library("OptimalCutpoints")
datacut<-traincut[,c("fclass4",f)]
optimal.Youden <- optimal.cutpoints(X =f,status ="fclass4",tag.healthy =0,
                                    methods ="Youden",data = datacut,
                                    ci.fit = TRUE, conf.level = 0.95)
cutoff<-optimal.Youden[["Youden"]][["Global"]][["optimal.cutoff"]]$cutoff
cat(cutoff)
plot(optimal.Youden, which = 1,col = "red", ylim = c(0,1)) #plot1
plot(optimal.Youden, which = 3,col = "red", ylim = c(0,1)) #plot2
colname<-paste(f,cutoff, sep = "_")
newcol<-as.data.frame(ifelse(traincut[,f] >= cutoff , "1", "0"))
colnames(newcol)<-colname
traincut<-cbind(traincut,newcol)
                        }

for(i in c("age","ALB", "IGG")){traincut<-newcutoffcol(i)}
#generate new col according to cutoff value

dput(names(traincut))

for(i in c("age_48",  "ALB_25.7","IGG_13.2")) {traincut[,i] <- as.factor(traincut[,i])}

# save(traincut,file="traincut_130.Rdata")

fit.full <- glm(fclass4 ~ UP24H_2.27,
                data=traincut,family=binomial(link="logit"))
summary(fit.full)#0.0000000474 ***
```

```{r CUTOFF_testing set}
dput(names(traincut))
testcut<-testData
testcutoffcol=function(f,cutoff){
colname<-paste(f,cutoff, sep = "_")
newcol<-as.data.frame(ifelse(testcut[,f] >= cutoff , "1", "0"))
colnames(newcol)<-colname
testcut<-cbind(testcut,newcol)
                                 }

("sleduration_0.92", "LNduration_0.17", "AI_7", 
"cellcrescent_0.14", "sclerosis_0.32", "TIshrink_10", "UP24H_2.4", 
"RBC_27", "CR_101", "BNP_26", "CRP_0.43")
for(i in c("age_48",  "ALB_25.7","IGG_13.2")) 

testcut<-testcutoffcol("age",48)
testcut<-testcutoffcol("sleduration",0.92)
testcut<-testcutoffcol("LNduration",0.17)
testcut<-testcutoffcol("AI",7)
testcut<-testcutoffcol("cellcrescent",0.14)
testcut<-testcutoffcol("sclerosis",0.32)
testcut<-testcutoffcol("TIshrink",10)
testcut<-testcutoffcol("UP24H",2.4)
testcut<-testcutoffcol("ALB",25.7)
testcut<-testcutoffcol("RBC",27)
testcut<-testcutoffcol("CR",101)
testcut<-testcutoffcol("BNP",26)
testcut<-testcutoffcol("CRP",0.43)
testcut<-testcutoffcol("IGG",13.2)

for(i in c( "sleduration_0.92", "LNduration_0.17", "AI_7", 
"cellcrescent_0.14", "sclerosis_0.32", "TIshrink_10", "UP24H_2.4", 
"RBC_27", "CR_101", "BNP_26", "CRP_0.43", "age_48", "ALB_25.7", 
"IGG_13.2")) {testcut[,i] <- as.factor(testcut[,i])}
vis_miss(testcut)
# save(testcut,file="testcut_64.Rdata")
```

```{r}
load("testcut_45.Rdata")
load("traincut_149.Rdata")
```

#LR_vs_OTHERS


```{r_merge group_decision tree_the result is not satisfactory}
library(party)
library(mlbench)

control<-ctree_control(mincriterion= 0.90)
m1_ctree<-ctree(trainData$fclass4 ~., data = trainData,controls = control)
table(predict(m1_ctree), trainData$fclass4)
plot(m1_ctree)
table(predict(m1_ctree), trainData$fclass4)

#https://zhuanlan.zhihu.com/p/28416543
```


```{r regression planA_merge41,43_42,44}
library(glmnet)

dput(names(trainData))
trainData<-traincut[,c("fclass4","gender", "newonsetLN", 
"AKI", "LNCLASS_si",  "debri",  
"TIsclerosis",   "HTN", "priois",  "age","sleduration",  "LNduration", "AI",  "cellcrescent", "sclerosis", "TIshrink","UP24H", "ALB", "RBC", "CR", "BNP", "CRP", "IGG")]

##stepwise regression-backward
fit.full.step<-glm(fclass4 ~.,
                   data=trainData,family = binomial(link="logit"))
summary(fit.full.step)

fit.full.step1<-step(fit.full.step,direction = "backward")
summary(fit.full.step1)

###all subset regression
# install.packages("leaps")
library(leaps)
leaps<-regsubsets(fclass4 ~. , data=trainData, nbest=1)
plot(leaps, scale="adjr2")
leaps[["rss"]]

###LASSO regression
lassodata<-trainData
# lassodata<-traincut1
for(i in names(lassodata)[c(1:22)]) {lassodata[,i] <- as.numeric(lassodata[,i])}    #numeric
library("glmnet")
set.seed(123) 

x <- as.matrix(lassodata[,2:22])
y <- lassodata[, c("fclass4")]
fitCV <- cv.glmnet(x, y, family = "binomial",type.measure = "class",nfolds = 20)#standardize=TRUE
print(fitCV);plot(fitCV)
fit <- glmnet(x, y, family = "binomial", alpha = 1) # make sure alpha = 1
plot(fit, xvar="lambda",label = TRUE);print(fit)

lambda= 0.076440  #min+1se
abline(v = log(lambda), lty = 3,lwd = 2,col = "black")# get the coef
#model
coef.min = coef(fitCV, s = lambda  ) 
coef.min

lambda=0.072950  #min
abline(v = log(lambda), lty = 3,lwd = 2,col = "black")# get the coef
#model
coef.min = coef(fitCV, s = lambda) 
coef.min
```

```{r trian model1  logi_regression LB VS others}
# as_train<-triancut
as_train<-trainData
trainData$fclass4<-as.factor(trainData$fclass4)
fit.full.step<-glm(fclass4 ~ age+ALB+sleduration,data=trainData,family = binomial(link="logit"))#model1 0.846 0.854

##summary models
library("stargazer")
#model
stargazer(fit.full.step,title="Logistic Regression Model",type="text")
cbind(coef= coef(fit.full.step),confint(fit.full.step))
exp(cbind(OR= coef(fit.full.step),confint(fit.full.step)))
summary(fit.full.step)

#ROC curves
data1<-as_train
prob <- fit.full.step$fitted.values;data1$prob<-prob
pgroup <- ifelse(prob > 0.5, "1", "0");data1$pgroup <- pgroup
t <- table(data1$fclass4,data1$pgroup)
rownames(t) <- c("Obs. neg","Obs. pos")
colnames(t) <- c("Pred. neg","Pred. pos")
prop.table(t)*100
efficiency <- sum(diag(t))/sum(t)  #efficiency=0.7769231
library("pROC")

roc1a <- roc(fclass4~prob, data = data1,smooth=F)
plot(roc1a, print.auc=TRUE, print.thres=TRUE,main = "ROC CURVE trainbio",
     col="#0072B5FF",print.thres.col="#BC3C29FF",identity.col="#0072B5FF",identity.lty=1,identity.lwd=1)
ci.auc(roc1a)

#predict the response-probability of the first observation
obs <- data1[1,]
predict(newdata=obs,fit.full.step,"response") #0.4493

#nomogram--take the first observation as an example
library("regplot")
regplot(fit.full.step,observation = obs,droplines=T,prfail = T,clickable = TRUE)
```

```{r test model1}
# as_test<-testcut
as_test<-testData
#ROC
predictpro<- predict.glm(fit.full.step,type='response',newdata=as_test)
predict =ifelse(predictpro>0.5,1,0)
as_test$prob = predictpro
as_test$predict = predict

roc1e <- roc(fclass4~prob, data = as_test,smooth=F)
plot(roc1e, print.auc=TRUE, print.thres=TRUE,main = "ROC CURVE",col="#0072B5FF",print.thres.col="#BC3C29FF",identity.col="#0072B5FF",identity.lty=1,identity.lwd=1)
ci.auc(roc1e)
```

```{r trian model2  logi_regression LB VS others}

fit.full.step<-glm(fclass4 ~ age+UP24H+sleduration+ALB,data=trainData,family = binomial(link="logit"))#model2 0.869 0.876  ##final model

##############
library("stargazer")
#model
stargazer(fit.full.step,title="Logistic Regression Model",type="text")
cbind(coef= coef(fit.full.step),confint(fit.full.step))
exp(cbind(OR= coef(fit.full.step),confint(fit.full.step)))
summary(fit.full.step)

#ROC
data1<-as_train
prob <- fit.full.step$fitted.values;data1$prob<-prob
pgroup <- ifelse(prob > 0.5, "1", "0");data1$pgroup <- pgroup
t <- table(data1$fclass4,data1$pgroup)
rownames(t) <- c("Obs. neg","Obs. pos")
colnames(t) <- c("Pred. neg","Pred. pos")
prop.table(t)*100
efficiency <- sum(diag(t))/sum(t)  #efficiency=0.7769231
library("pROC")

roc2a <- roc(fclass4~prob, data = data1,smooth=F)
plot(roc2a, print.auc=TRUE, print.thres=TRUE,main = "ROC CURVE trainbio",
     col="#0072B5FF",print.thres.col="#BC3C29FF",identity.col="#0072B5FF",identity.lty=1,identity.lwd=1)
ci.auc(roc2a)

#predict the response-probability of the first observation
obs <- data1[1,]
predict(newdata=obs,fit.full.step,"response") #0.4493

#nomogram--take the first observation as an example
library("regplot")

regplot(fit.full.step,observation = obs,droplines=T,prfail = T,clickable = TRUE)
```


```{r test model2}

# as_test<-testcut
as_test<-testData
#ROC
predictpro<- predict.glm(fit.full.step,type='response',newdata=as_test)
predict =ifelse(predictpro>0.5,1,0)
as_test$prob = predictpro
as_test$predict = predict

roc2e <- roc(fclass4~prob, data = as_test,smooth=F)
plot(roc2e, print.auc=TRUE, print.thres=TRUE,main = "ROC CURVE",col="#0072B5FF",print.thres.col="#BC3C29FF",identity.col="#0072B5FF",identity.lty=1,identity.lwd=1)
ci.auc(roc2e)
```


```{r trian model3 logi_regression LB VS others}

fit.full.step<-glm(fclass4 ~ age+UP24H+sleduration+ALB+LNCLASS_si,data=trainData,family = binomial(link="logit"))#model3 0.878 0.855

##############
library("stargazer")
#model
stargazer(fit.full.step,title="Logistic Regression Model",type="text")
cbind(coef= coef(fit.full.step),confint(fit.full.step))
exp(cbind(OR= coef(fit.full.step),confint(fit.full.step)))
summary(fit.full.step)

#ROC
data1<-as_train
prob <- fit.full.step$fitted.values;data1$prob<-prob
pgroup <- ifelse(prob > 0.5, "1", "0");data1$pgroup <- pgroup
t <- table(data1$fclass4,data1$pgroup)
rownames(t) <- c("Obs. neg","Obs. pos")
colnames(t) <- c("Pred. neg","Pred. pos")
prop.table(t)*100
efficiency <- sum(diag(t))/sum(t)  #efficiency=0.7769231
library("pROC")

roc3a <- roc(fclass4~prob, data = data1,smooth=F)
plot(roc3a, print.auc=TRUE, print.thres=TRUE,main = "ROC CURVE trainbio",
     col="#0072B5FF",print.thres.col="#BC3C29FF",identity.col="#0072B5FF",identity.lty=1,identity.lwd=1)
ci.auc(roc3a)

#predict the response-probability of the first observation
obs <- data1[1,]
predict(newdata=obs,fit.full.step,"response") #0.4493

#nomogram--take the first observation as an example
library("regplot")

regplot(fit.full.step,observation = obs,droplines=T,prfail = T,clickable = TRUE)
```


```{r test model3}
# as_test<-testcut
as_test<-testData
#ROC
predictpro<- predict.glm(fit.full.step,type='response',newdata=as_test)
predict =ifelse(predictpro>0.5,1,0)
as_test$prob = predictpro
as_test$predict = predict

roc3e <- roc(fclass4~prob, data = as_test,smooth=F)
plot(roc3e, print.auc=TRUE, print.thres=TRUE,main = "ROC CURVE",col="#0072B5FF",print.thres.col="#BC3C29FF",identity.col="#0072B5FF",identity.lty=1,identity.lwd=1)
ci.auc(roc3e)
```

```{r delong test}
#train：bio vs nobio------------------
roc.test(roc1a,roc1e,method = 'delong')
#1vs2
roc.test(roc1a,roc2a,method = 'delong') #p-value = 0.04771
roc.test(roc1e,roc2e,method = 'delong') #p-value = 0.0007127
#2vs3
roc.test(roc2a,roc3a,method = 'delong') #p-value = 0.3076
roc.test(roc2e,roc3e,method = 'delong') #p-value = 0.07791

#2vs3
roc.test(roc2a,roc2e,method = 'delong') #p-value = 0.907

```
